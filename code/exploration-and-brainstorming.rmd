c---
title: "NFPA"
author: "David Marx"
date: "January 23, 2017"
output: html_document
---

NB: Make liberal use of data dictionary. Be selective in the analysis. Start with hypothesis
generation.

NB: Dataset is incomplete. Q 31 cuts off at 5 options, but 31 in survey. Missing all of 32-46, and part VIII (three-part free text)

--> This is actually false, the columns are just out of order.

# Setup Workspace

```{r, echo=FALSE, message=FALSE}
library(data.table)
library(magrittr)
library(stringr)
library(ggplot2)
library(ggExtra)
```

```{r}
basepath <- 'C:/Users/davidmarx/Documents/Projects/Toy Projects/nfpa/'
survey <- read.csv(paste0(basepath, 'data/raw/FireService_DataSet.csv'), stringsAsFactors=FALSE) 
nrow(survey) # 5458
#as.data.table(survey)
```

Handle nulls. Assumption: the following are equivalent in the worksheet:
* empty cell
* The string '#NULL'
* white space
* empty string
* numbers delimited by commas *
  * Identify numeric columns by testing the percent of entries that can be successfully coerced
    to numeric after applying other fixes. Also test for max character length of column

```{r}
attempt_numeric_coersion = function(column, coersion_succ_threshold=0, max_char=10){
  obs_max_nchar = max(nchar(column))
  if(obs_max_nchar>max_char) return(column)
  column = str_replace(column, ',', '')
  column_coerced = as.numeric(column)
  if(sum(is.na(column_coerced))/length(column)>coersion_succ_threshold){
    return(column)
  }
  return(column_coerced)
}

clean_column_nulls = function(column, replace_val=0) {
  column[is.na(column)]      <- replace_val
  column[column == '#NULL!'] <- replace_val
  attempt_numeric_coersion(column)
  #column[is.na(column)]      <- replace_val # This is probably gonna obfuscate errors
}
```

```{r, warning=FALSE}
# I'd rather do this on a case by case basis, but given the timeframe I'm supposed to 
# have this complete by, I just need to get this in a functional state. 3-5 hours for
# such a wide and messy dataset is a pretty tough ask.
survey_cleaned = copy(survey)
for(column in names(survey)){
  survey_cleaned[,column] = clean_column_nulls(survey[,column])
}
survey_dt <- data.table(survey_cleaned)
save(survey_dt, file=paste0(basepath, 'data/processed/survey_dt.rdata'))
```



# Columns of interest via data dictionary

see `documentation/data_dictionary_notes.xlsx`

# Exploration

Personnel change (paid)

```{r}
survey_dt[,net_personnel_change:=0]
survey_dt[,net_personnel_change:=q5.1-q5.2]
survey_dt[,perc_personnel_change:=(q6-net_personnel_change)/q6]
h = survey_dt[,hist(net_personnel_change, breaks=50)]
plot(h$mids, h$counts, type='h', log='y') # log normal, mostly negligible net change

survey_dt[q6==0, .N] # 2858
survey_dt[q6==0, .N]/survey_dt[,.N] # 52% of departments have no full-time paid personnel

survey_dt[,plot(q6, net_personnel_change, main='Change as a function of total personnel')]

h2 = survey_dt[q6>0,hist(perc_personnel_change, main='Percent change from 2011')]
plot(h2$mids, h2$counts, type='h')

xv = seq(0,5, by=.01)
ecdf_fn = survey_dt[,ecdf(abs(perc_personnel_change))]
survey_dt[q6>0,plot(xv, ecdf_fn(xv))]
#(right_tail = 1-ecdf_fn(1000)) # .0714
(ecdf_fn(2)) # 0.9182143
(ecdf_fn(5)) # 0.9257143
survey_dt[q6>0,max(abs(perc_personnel_change))] # 11

#### Replace ecdf with boxplot? ####


save(survey_dt, file=paste0(basepath, 'data/processed/survey_dt.rdata'))
```

52% of departments have no full-time paid personnel. Of those that have paid personnel, 92% of departments are within 2% of paid staffing levels from 2011. 

--> compare against part-time/volunteer/total

```{r}
ecdf_fn = ecdf(survey_dt[q6>0, abs(perc_personnel_change)])
yv <- ecdf_fn(2)

gg <- ggplot(survey_dt[q6>0], 
             aes(abs(perc_personnel_change), 100*ecdf_fn(abs(perc_personnel_change)))) +
        geom_line() +
        #stat_ecdf(geom='line') +
        #geom_text(color='red', size=3, label=round(yv,2), aes(x=2, y=yv), hjust=1, vjust=0) +
        geom_vline(color="red", xintercept = 2, linetype = "longdash") +
        scale_x_continuous(breaks=c(0,2,4,6,8,10)) +
        labs(x="Absolute % Personnel Change (Paid)",
             y="Cumulative Percent of Depts w/Paid Personnel"
             )
        
gg
  
```

```{r, echo=FALSE}

gg <- ggplot(survey_dt[q6>0], aes(x=1,y=perc_personnel_change)) + 
        geom_boxplot()

ggExtra::ggMarginal(gg, type = "histogram", margins='y')
  
# Distribution is so tight, the boxplot presents as a flat line. Not worth it. 
# Stick with eCDF
```

## Investigatory questions:

* What states/jurisdictions have the highest female representation in the fire service? 
  * Choropleth visualization
* is there a difference between representation of women among career staff vs volunteer?
  * Proportions test between career/volunteer
    * Bucketed by agency size quartiles
  * regression to control for agency size 
  * regression to control for state, population, agency size
    * multiply sate indicator with career/volunteer indicator to highlight bad states?
      * Brainfarting on the word for this. If I do this, need to look this up.
* Can we cluster departments based on their makeup?
  * Roles/Training levels of personnel
  * Types and age of apparatus
  
```{r}
survey_dt[,total_ff:= q6 + q11]
survey_dt[,female_ff:= q6.1 + q11.1]
survey_dt[,perc_female:= female_ff/total_ff]
#survey_dt[,plot(total_ff, female_ff, log='xy')]
#survey_dt[,plot(total_ff, female_ff/total_ff, log='x')]

women_by_state <- survey_dt[, .(total_ff=sum(total_ff), female_ff=sum(female_ff)), .(state)]
women_by_state[,perc_female:=female_ff/total_ff]

women_by_state[,plot(total_ff, perc_female)]
mod <- lm(perc_female~total_ff, women_by_state)
women_by_state[,plot(total_ff, perc_female)]
abline(mod)
summary(mod)
```

```{r}
# Compare female representation between volunteer and paid departments
# Fit models for volunteer and paid/fte respectively. Do ANOVA between two models
# to test difference in representation.

survey_dt[,plot(q6, q6.1, main='Paid/FTE')]
survey_dt[,points(q11, q11.1, col='blue')]

paid <- survey_dt[q6>20,.(total_ff=q6, female_ff=q6.1, categ='paid')]
vol  <- survey_dt[q11>20,.(total_ff=q11, female_ff=q11.1, categ='vol')]
all = rbindlist(list(paid, vol))
mod_paid <- lm(female_ff~total_ff, paid)
mod_vol  <- lm(female_ff~total_ff, vol)

#anova(mod_paid, mod_vol)
summary(mod_paid) # poor fit
summary(mod_vol) # poor fit

mod_full = lm(female_ff~total_ff + categ, all)
summary(mod_full)
plot(mod_full)

mod_prob <- glm(1*(categ=='vol')~female_ff + total_ff, data=all, family=binomial)
summary(mod_prob) 
# positive valued coeffificient for female_ff indicates that when controlling for department
# size, women have better representation on the part-time/volunteer side than paid/FTE.
# 
# Goal: turn this into a more easily digested finding, preferably a plot.
# --> devil's horn plot
```
